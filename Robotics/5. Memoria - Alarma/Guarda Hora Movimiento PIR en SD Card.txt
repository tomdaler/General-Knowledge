#include <SPI.h>
#include <SD.h>

#include <TimeAlarms.h>
#include <Time.h>

int SenPIR = 2;
String sFileName = "data.txt";

void setup()
{
   pinMode(SenPIR,INPUT);
   Serial.begin(9600);

   byte bHora = EEPROM.read(0);
   int minuto = 0;
 
   setTime(bHora, minuto, 0, 1, 11, 11);
   Alarm.delay(1000);
}

void loop()
{
   String s1 = Serial.StringRead();

   if (s1 >= "0" || s1 <= "24") SetHour(s1);

   CheckPIR();

   if (s1 == "l" || s1 =="L") LeerSD();
}

void SetHour(char str1)
{
   byte hora = (byte)str1;
   EEPROM.update(0, hora);
}

void CheckPIR()
{
   int sensorPIR = digitalRead(SenPIR);
   if (sensorPIR ==0) return;

   int hh = hour();
   int mm = minute();

   String data = String(hh)+":"+String(mm);
   
   SD.begin(4);
   dataFile = SD.open(sFileName, FILE_WRITE);
   dataFile.println(data);
   SD.close("data.txt");

   // Espere 5 minutos para monitorear movimiento
   delay(5 * 60 * 1000);
}

void LeerSD()
{
   File myFile = SD.open(sFileName);
   if (myFile) {
   while (myFile.available())
        Serial.prinln(myFile.read());
   } 
   myFile.close();
}
